AWSTemplateFormatVersion: "2010-09-09"

Parameters:
  Cluster:
    Type: String
    Description: Name of Cluster to host services and tasks
  Domain:
    Type: String
    Description: Domain name for Traefik to use
  TargetGroup:
    Type: String
    Description: TargetGroup for internet traffic
  TargetGroup8080:
    Type: String
    Description: TargetGroup for Traefik traffic

  SecurityGroupWeb:
    Type: String
    Description: SecurityGroup for internet traffic
  SubnetPrivateOne:
    Type: String
    Description: Subnet A in a VPC
  SubnetPrivateTwo:
    Type: String
    Description: Subnet B in a VPC

Resources:
  RoleTraefik:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-traefik
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - ecs:*
                  - ecs:ListClusters
                  - ecs:DescribeClusters
                  - ecs:ListTasks
                  - ecs:DescribeTasks
                  - ecs:DescribeContainerInstances
                  - ecs:DescribeTaskDefinition
                  - ec2:DescribeInstances
                Resource: "*"

  ServiceTraefik:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref Cluster
      TaskDefinition: !Ref TaskDefinitionTraefik
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref SecurityGroupWeb
          Subnets:
            - !Ref SubnetPrivateOne
            - !Ref SubnetPrivateTwo
      DesiredCount: 1
      LoadBalancers:
        - ContainerName: traefik
          ContainerPort: 80
          TargetGroupArn: !Ref TargetGroup
        - ContainerName: traefik
          ContainerPort: 8080
          TargetGroupArn: !Ref TargetGroup8080

  TaskDefinitionTraefik:
    Type: AWS::ECS::TaskDefinition
    Properties:
      NetworkMode: awsvpc
      ContainerDefinitions:
        - Image: andrewgryan/traefik-ecs:latest
          Environment:
            - Name: CLUSTER
              Value: !Ref Cluster
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: DOMAIN
              Value: !Ref Domain
          Name: traefik
          Memory: 32
          PortMappings:
            - ContainerPort: 80
              HostPort: 80
            - ContainerPort: 8080
              HostPort: 8080
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref LogGroup
              awslogs-stream-prefix: !Ref AWS::StackName
      TaskRoleArn: !Ref RoleTraefik

  ServiceNGINX:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref Cluster
      TaskDefinition: !Ref TaskDefinitionNGINX
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref SecurityGroupWeb
          Subnets:
            - !Ref SubnetPrivateOne
            - !Ref SubnetPrivateTwo
      DesiredCount: 1

  TaskDefinitionNGINX:
    Type: AWS::ECS::TaskDefinition
    Properties:
      NetworkMode: awsvpc
      ContainerDefinitions:
        - Image: nginx:latest
          Name: nginx
          Memory: 32
          PortMappings:
            - ContainerPort: 80
              HostPort: 80
          DockerLabels:
            traefik.http.routers.nginx.rule: !Sub Host(`${Domain}`)
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref LogGroup
              awslogs-stream-prefix: !Ref AWS::StackName

  ServiceSolidJS:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref Cluster
      TaskDefinition: !Ref TaskDefinitionSolidJS
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref SecurityGroupWeb
          Subnets:
            - !Ref SubnetPrivateOne
            - !Ref SubnetPrivateTwo
      DesiredCount: 1

  TaskDefinitionSolidJS:
    Type: AWS::ECS::TaskDefinition
    Properties:
      NetworkMode: awsvpc
      ContainerDefinitions:
        - Image: andrewgryan/my-solidjs-app:latest
          Name: solidjs
          Memory: 32
          PortMappings:
            - ContainerPort: 80
              HostPort: 80
          DockerLabels:
            traefik.http.routers.solidjs.rule: !Sub Host(`${Domain}`) && PathPrefix(`/solidjs`)
            traefik.http.middlewares.solidjs-stripprefix.stripprefix.prefixes: /solidjs
            traefik.http.middlewares.solidjs-stripprefix.stripprefix.forceSlash: false
            traefik.http.routers.solidjs.middlewares: solidjs-stripprefix@ecs
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref AWS::Region
              awslogs-group: !Ref LogGroup
              awslogs-stream-prefix: !Ref AWS::StackName

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub ${AWS::StackName}-logs
      RetentionInDays: 14
